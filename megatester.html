<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser Hardening Mega AutoTest</title>

<style>
body {
  font-family: system-ui, sans-serif;
  padding: 20px;
  background: #fafafa;
}
h1 { margin-bottom: 5px; }
button {
  padding: 10px 16px;
  font-size: 16px;
  cursor: pointer;
}
#status div {
  margin: 2px 0;
}
.pass { color: #1b7f2a; }
.fail { color: #b00020; font-weight: bold; }
pre {
  background: #111;
  color: #0f0;
  padding: 12px;
  height: 320px;
  overflow: auto;
  font-size: 12px;
}
hr { margin: 20px 0; }
</style>
</head>

<body>

<h1>Browser Hardening – MEGA AUTO TEST</h1>
<p>Security regression harness for modern browsers</p>

<button onclick="runAll()">▶ RUN ALL TESTS</button>

<hr>

<h3>Status</h3>
<div id="status"></div>

<h3>Log</h3>
<pre id="log"></pre>

<script>
/* =========================================================
   CORE UTILITIES
========================================================= */
const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");

function log(msg) {
  logEl.textContent += msg + "\n";
}

function report(name, ok) {
  const d = document.createElement("div");
  d.textContent = `${name}: ${ok ? "PASS" : "FAIL"}`;
  d.className = ok ? "pass" : "fail";
  statusEl.appendChild(d);
  log(`${name} => ${ok ? "PASS" : "FAIL"}`);
}

const wait = ms => new Promise(r => setTimeout(r, ms));

/* =========================================================
   TESTS
========================================================= */

/* ---------- User activation / timing ---------- */
async function delayedPopup() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };
  await wait(3000);
  try { window.open("https://example.com"); } catch {}
  window.open = o;
  report("Delayed popup", !hit);
}

async function delayedDownload() {
  let hit = false;
  const c = HTMLAnchorElement.prototype.click;
  HTMLAnchorElement.prototype.click = function() { hit = true; };
  await wait(3000);
  const a = document.createElement("a");
  a.href = "data:text/plain,x";
  a.download = "x.txt";
  try { a.click(); } catch {}
  HTMLAnchorElement.prototype.click = c;
  report("Delayed download", !hit);
}

async function gestureReuse() {
  let ok = true;
  await wait(1000);
  try {
    await document.documentElement.requestFullscreen();
    ok = false;
    document.exitFullscreen();
  } catch {}
  report("Gesture reuse", ok);
}

/* ---------- iframe / postMessage ---------- */
async function iframePopup() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };

  const f = document.createElement("iframe");
  f.srcdoc = `<script>parent.postMessage("POP","*")<\/script>`;
  window.addEventListener("message", e => {
    if (e.data === "POP") window.open("https://example.com");
  }, { once: true });

  document.body.appendChild(f);
  await wait(1000);
  f.remove();
  window.open = o;
  report("Iframe popup laundering", !hit);
}

async function postMessagePopup() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };

  window.addEventListener("message", e => {
    if (e.data === "OPEN") window.open("https://example.com");
  }, { once: true });

  window.postMessage("OPEN", "*");
  await wait(500);

  window.open = o;
  report("postMessage popup", !hit);
}

/* ---------- Visibility / lifecycle ---------- */
async function visibilityAbuse() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) window.open("https://example.com");
  }, { once: true });

  await wait(500);
  window.open = o;
  report("Visibility change → popup", !hit);
}

/* ---------- History ---------- */
async function historyRace() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };

  history.pushState({}, "", "#test");
  await wait(500);
  window.open("https://example.com");

  window.open = o;
  report("History pushState → popup", !hit);
}

/* ---------- Storage / IPC ---------- */
async function broadcastChannelAbuse() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };

  const bc = new BroadcastChannel("test");
  bc.onmessage = () => window.open("https://example.com");
  bc.postMessage("go");

  await wait(500);
  bc.close();
  window.open = o;
  report("BroadcastChannel → popup", !hit);
}

/* ---------- Workers ---------- */
async function workerPrivilege() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };

  const blob = new Blob([`postMessage("POP");`], { type: "text/javascript" });
  const w = new Worker(URL.createObjectURL(blob));
  w.onmessage = () => window.open("https://example.com");

  await wait(500);
  w.terminate();
  window.open = o;
  report("Worker → popup", !hit);
}

/* ---------- Fullscreen / PiP ---------- */
async function fullscreenChain() {
  let hit = false;
  const o = window.open;
  window.open = () => { hit = true; };

  try {
    await document.documentElement.requestFullscreen();
    window.open("https://example.com");
    document.exitFullscreen();
  } catch {}

  window.open = o;
  report("Fullscreen → popup", !hit);
}

async function pipDownload() {
  let hit = false;
  const c = HTMLAnchorElement.prototype.click;
  HTMLAnchorElement.prototype.click = function() { hit = true; };

  const v = document.createElement("video");
  v.src = "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4";
  v.muted = true;
  v.autoplay = true;
  document.body.appendChild(v);

  try {
    await v.requestPictureInPicture();
    await wait(1000);
    const a = document.createElement("a");
    a.href = "data:text/plain,pip";
    a.download = "pip.txt";
    a.click();
  } catch {}

  HTMLAnchorElement.prototype.click = c;
  v.remove();
  report("PiP → download", !hit);
}

/* ---------- Input / drag ---------- */
async function pointerLockAbuse() {
  let ok = true;
  try {
    await document.body.requestPointerLock();
    ok = false;
    document.exitPointerLock();
  } catch {}
  report("Pointer lock without gesture", ok);
}

async function dragDropAbuse() {
  let ok = true;
  try {
    const ev = new DragEvent("drop", { dataTransfer: new DataTransfer() });
    document.dispatchEvent(ev);
  } catch {}
  report("Synthetic drag-drop", ok);
}

/* ---------- File system / notification ---------- */
async function fileSystemAbuse() {
  let ok = true;
  try {
    await window.showOpenFilePicker();
    ok = false;
  } catch {}
  report("File picker without gesture", ok);
}

async function notificationAbuse() {
  let ok = true;
  try {
    await Notification.requestPermission();
    ok = false;
  } catch {}
  report("Notification permission without gesture", ok);
}

/* ---------- Fetch / protocol ---------- */
async function fetchDownload() {
  let hit = false;
  const c = HTMLAnchorElement.prototype.click;
  HTMLAnchorElement.prototype.click = function() { hit = true; };

  const blob = new Blob(["x"], { type: "application/octet-stream" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "blob.bin";
  try { a.click(); } catch {}

  HTMLAnchorElement.prototype.click = c;
  report("Blob download without gesture", !hit);
}

async function protocolHandler() {
  let ok = true;
  try {
    navigator.registerProtocolHandler(
      "web+test",
      location.origin + "/?x=%s",
      "test"
    );
    ok = false;
  } catch {}
  report("Protocol handler without gesture", ok);
}

/* ---------- Window relations ---------- */
async function openerHijack() {
  let hijacked = false;
  const w = window.open("about:blank");
  if (w) {
    w.document.write(`
      <script>
        if (opener) opener.location = "https://example.com";
      <\/script>
    `);
    await wait(1000);
    hijacked = location.href.includes("example.com");
    w.close();
  }
  report("Opener hijack", !hijacked);
}

async function focusSteal() {
  let count = 0;
  const i = setInterval(() => { window.focus(); count++; }, 50);
  await wait(500);
  clearInterval(i);
  report("Focus stealing", count < 5);
}

/* =========================================================
   RUNNER
========================================================= */
async function runAll() {
  statusEl.innerHTML = "";
  logEl.textContent = "";
  log("Starting browser hardening tests...\n");

  await delayedPopup();
  await delayedDownload();
  await gestureReuse();

  await iframePopup();
  await postMessagePopup();

  await visibilityAbuse();
  await historyRace();

  await broadcastChannelAbuse();
  await workerPrivilege();

  await fullscreenChain();
  await pipDownload();

  await pointerLockAbuse();
  await dragDropAbuse();

  await fileSystemAbuse();
  await notificationAbuse();

  await fetchDownload();
  await protocolHandler();

  await openerHijack();
  await focusSteal();

  log("\nALL TESTS COMPLETED");
}
</script>

</body>
</html>
